

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>HTTP Parser - Huimin Qu</title>







<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="Huimin Qu">
<meta property="og:title" content="HTTP Parser">


  <link rel="canonical" href="http://localhost:4000/vendor/bundle/gems/http_parser.rb-0.6.0/ext/ruby_http_parser/vendor/http-parser/">
  <meta property="og:url" content="http://localhost:4000/vendor/bundle/gems/http_parser.rb-0.6.0/ext/ruby_http_parser/vendor/http-parser/">







  

  












  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Huimin Qu",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Huimin Qu Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    

<!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="57x57" href="http://localhost:4000/images/apple-touch-icon-57x57.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="60x60" href="http://localhost:4000/images/apple-touch-icon-60x60.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="76x76" href="http://localhost:4000/images/apple-touch-icon-76x76.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="120x120" href="http://localhost:4000/images/apple-touch-icon-120x120.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="152x152" href="http://localhost:4000/images/apple-touch-icon-152x152.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/images/apple-touch-icon-180x180.png?v=M44lzPylqQ">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32">
<link rel="icon" type="image/png" href="http://localhost:4000/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16">
<link rel="manifest" href="http://localhost:4000/images/manifest.json?v=M44lzPylqQ">
<link rel="mask-icon" href="http://localhost:4000/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000">
<link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ">
<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="http://localhost:4000/images/mstile-144x144.png?v=M44lzPylqQ">
<meta name="msapplication-config" content="http://localhost:4000/images/browserconfig.xml?v=M44lzPylqQ">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="http://localhost:4000/assets/css/academicons.css"/>

<script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://localhost:4000/">Huimin Qu</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/projects/">Projects</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/cv/">CV</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/miscellaneous/">Misc.</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    





<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://localhost:4000/images/profile_new.jpg" class="author__avatar" alt="Huimin Qu">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Huimin Qu</h3>
    <p class="author__bio">Ph.D. Candidate at SIfA (Sydney Institute for Astronomy)</p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Sydney, Australia</li>
      
      
      
      
        <li><a href="mailto:huqu9381@uni.sydney.edu.au"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
      
      
      
      
      
      
      
      
      
      
      
        <li><a href="https://github.com/HuiminQu"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="HTTP Parser">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">HTTP Parser
</h1>
          
        
        
        
        
             
        
    
        </header>
      

      <section class="page__content" itemprop="text">
        <h1 id="http-parser">HTTP Parser</h1>

<p>This is a parser for HTTP messages written in C. It parses both requests and
responses. The parser is designed to be used in performance HTTP
applications. It does not make any syscalls nor allocations, it does not
buffer data, it can be interrupted at anytime. Depending on your
architecture, it only requires about 40 bytes of data per message
stream (in a web server that is per connection).</p>

<p>Features:</p>

<ul>
  <li>No dependencies</li>
  <li>Handles persistent streams (keep-alive).</li>
  <li>Decodes chunked encoding.</li>
  <li>Upgrade support</li>
  <li>Defends against buffer overflow attacks.</li>
</ul>

<p>The parser extracts the following information from HTTP messages:</p>

<ul>
  <li>Header fields and values</li>
  <li>Content-Length</li>
  <li>Request method</li>
  <li>Response status code</li>
  <li>Transfer-Encoding</li>
  <li>HTTP version</li>
  <li>Request URL</li>
  <li>Message body</li>
</ul>

<h2 id="usage">Usage</h2>

<p>One <code class="language-plaintext highlighter-rouge">http_parser</code> object is used per TCP connection. Initialize the struct
using <code class="language-plaintext highlighter-rouge">http_parser_init()</code> and set the callbacks. That might look something
like this for a request parser:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http_parser_settings settings;
settings.on_path = my_path_callback;
settings.on_header_field = my_header_field_callback;
/* ... */

http_parser *parser = malloc(sizeof(http_parser));
http_parser_init(parser, HTTP_REQUEST);
parser-&gt;data = my_socket;
</code></pre></div></div>

<p>When data is received on the socket execute the parser and check for errors.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>size_t len = 80*1024, nparsed;
char buf[len];
ssize_t recved;

recved = recv(fd, buf, len, 0);

if (recved &lt; 0) {
  /* Handle error. */
}

/* Start up / continue the parser.
 * Note we pass recved==0 to signal that EOF has been recieved.
 */
nparsed = http_parser_execute(parser, &amp;settings, buf, recved);

if (parser-&gt;upgrade) {
  /* handle new protocol */
} else if (nparsed != recved) {
  /* Handle error. Usually just close the connection. */
}
</code></pre></div></div>

<p>HTTP needs to know where the end of the stream is. For example, sometimes
servers send responses without Content-Length and expect the client to
consume input (for the body) until EOF. To tell http_parser about EOF, give
<code class="language-plaintext highlighter-rouge">0</code> as the forth parameter to <code class="language-plaintext highlighter-rouge">http_parser_execute()</code>. Callbacks and errors
can still be encountered during an EOF, so one must still be prepared
to receive them.</p>

<p>Scalar valued message information such as <code class="language-plaintext highlighter-rouge">status_code</code>, <code class="language-plaintext highlighter-rouge">method</code>, and the
HTTP version are stored in the parser structure. This data is only
temporally stored in <code class="language-plaintext highlighter-rouge">http_parser</code> and gets reset on each new message. If
this information is needed later, copy it out of the structure during the
<code class="language-plaintext highlighter-rouge">headers_complete</code> callback.</p>

<p>The parser decodes the transfer-encoding for both requests and responses
transparently. That is, a chunked encoding is decoded before being sent to
the on_body callback.</p>

<h2 id="the-special-problem-of-upgrade">The Special Problem of Upgrade</h2>

<p>HTTP supports upgrading the connection to a different protocol. An
increasingly common example of this is the Web Socket protocol which sends
a request like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GET /demo HTTP/1.1
    Upgrade: WebSocket
    Connection: Upgrade
    Host: example.com
    Origin: http://example.com
    WebSocket-Protocol: sample
</code></pre></div></div>

<p>followed by non-HTTP data.</p>

<p>(See http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-75 for more
information the Web Socket protocol.)</p>

<p>To support this, the parser will treat this as a normal HTTP message without a
body. Issuing both on_headers_complete and on_message_complete callbacks. However
http_parser_execute() will stop parsing at the end of the headers and return.</p>

<p>The user is expected to check if <code class="language-plaintext highlighter-rouge">parser-&gt;upgrade</code> has been set to 1 after
<code class="language-plaintext highlighter-rouge">http_parser_execute()</code> returns. Non-HTTP data begins at the buffer supplied
offset by the return value of <code class="language-plaintext highlighter-rouge">http_parser_execute()</code>.</p>

<h2 id="callbacks">Callbacks</h2>

<p>During the <code class="language-plaintext highlighter-rouge">http_parser_execute()</code> call, the callbacks set in
<code class="language-plaintext highlighter-rouge">http_parser_settings</code> will be executed. The parser maintains state and
never looks behind, so buffering the data is not necessary. If you need to
save certain data for later usage, you can do that from the callbacks.</p>

<p>There are two types of callbacks:</p>

<ul>
  <li>notification <code class="language-plaintext highlighter-rouge">typedef int (*http_cb) (http_parser*);</code>
  Callbacks: on_message_begin, on_headers_complete, on_message_complete.</li>
  <li>data <code class="language-plaintext highlighter-rouge">typedef int (*http_data_cb) (http_parser*, const char *at, size_t length);</code>
  Callbacks: (requests only) on_uri,
             (common) on_header_field, on_header_value, on_body;</li>
</ul>

<p>Callbacks must return 0 on success. Returning a non-zero value indicates
error to the parser, making it exit immediately.</p>

<p>In case you parse HTTP message in chunks (i.e. <code class="language-plaintext highlighter-rouge">read()</code> request line
from socket, parse, read half headers, parse, etc) your data callbacks
may be called more than once. Http-parser guarantees that data pointer is only
valid for the lifetime of callback. You can also <code class="language-plaintext highlighter-rouge">read()</code> into a heap allocated
buffer to avoid copying memory around if this fits your application.</p>

<p>Reading headers may be a tricky task if you read/parse headers partially.
Basically, you need to remember whether last header callback was field or value
and apply following logic:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(on_header_field and on_header_value shortened to on_h_*)
 ------------------------ ------------ --------------------------------------------
| State (prev. callback) | Callback   | Description/action                         |
 ------------------------ ------------ --------------------------------------------
| nothing (first call)   | on_h_field | Allocate new buffer and copy callback data |
|                        |            | into it                                    |
 ------------------------ ------------ --------------------------------------------
| value                  | on_h_field | New header started.                        |
|                        |            | Copy current name,value buffers to headers |
|                        |            | list and allocate new buffer for new name  |
 ------------------------ ------------ --------------------------------------------
| field                  | on_h_field | Previous name continues. Reallocate name   |
|                        |            | buffer and append callback data to it      |
 ------------------------ ------------ --------------------------------------------
| field                  | on_h_value | Value for current header started. Allocate |
|                        |            | new buffer and copy callback data to it    |
 ------------------------ ------------ --------------------------------------------
| value                  | on_h_value | Value continues. Reallocate value buffer   |
|                        |            | and append callback data to it             |
 ------------------------ ------------ --------------------------------------------
</code></pre></div></div>

<h2 id="parsing-urls">Parsing URLs</h2>

<p>A simplistic zero-copy URL parser is provided as <code class="language-plaintext highlighter-rouge">http_parser_parse_url()</code>.
Users of this library may wish to use it to parse URLs constructed from
consecutive <code class="language-plaintext highlighter-rouge">on_url</code> callbacks.</p>

<p>See examples of reading in headers:</p>

<ul>
  <li><a href="http://gist.github.com/155877">partial example</a> in C</li>
  <li><a href="http://github.com/ry/http-parser/blob/37a0ff8928fb0d83cec0d0d8909c5a4abcd221af/test.c#L403">from http-parser tests</a> in C</li>
  <li><a href="http://github.com/ry/node/blob/842eaf446d2fdcb33b296c67c911c32a0dabc747/src/http.js#L284">from Node library</a> in Javascript</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        




      </footer>

      

      


    </div>

    
  </article>

  
  
</div>


    </script>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<a href="/sitemap/">Sitemap</a>
<!-- end custom footer snippets -->

        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="http://github.com/HuiminQu"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 Huimin Qu. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>






  </body>
</html>

